# Yet Another Unix Shell 设计报告

### 实验环境

本次实验在 Ubuntu 20.04.6 LTS 操作系统下使用 C 语言实现。

### 整体框架

Yet Another Unix Shell 实现了简单的 Linux 命令行解释器的功能，主要包含以下模块：

- 命令读取模块：用于读取输入命令字符串
- 命令解析模块：将读入的字符串命令转换为可执行的统一格式，具体包括两个步骤：
  - 词法解析：将命令划分为若干词元
  - 语法解析：分析词元关系，构建抽象语义树（Abstract Syntax Tree，AST）
- 命令执行模块：根据构建的 AST 执行相应命令
- 命令释放模块：命令结束后，释放命令资源

### 实现细节

#### 命令读取

命令读取模块调用 GNU readline 库实现，能够实现 Tab 键自动补全、查找历史命令等功能。

#### 命令解析

命令解析模块分为两部分：词法解析和语法解析。词法解析部分将输入命令按空格划分为多个词元，要求 `|`、`>`、`>>` 等特殊符号前后需有空格。语法解析部分分析词元语法关系，构建 AST。具体而言，AST 节点包含三类：

- 命令节点：包含命令名、参数个数、参数、是否后台执行等信息。命令节点只能为叶子节点。
- 重定向节点：包含重定向类型（输入、输出、续写）、重定向文件信息。其子节点为命令节点
- 管道节点：节点左子树为重定向节点或命令节点，记录管道左端命令；右子树为管道节点（支持管道级联）、重定向节点或命令节点。

构建 AST 的步骤大致为

1. 检查命令中是否存在 `|` 符号，若存在，则构建管道节点，在左子树处构建管道左端命令 AST，在右子树处递归构建右端命令 AST；
2. 检查命令中是否存在 `<`、`>`、`>>` 符号，若存在，则构建重定向节点，记录重定向类型和文件；
3. 构建命令节点，记录命令名、参数个数、参数、是否后台执行等信息。

#### 命令执行

命令执行模块从根节点出发，根据节点类型执行节点。

- 对于命令节点：首先判断是否为内置命令，若是，则在 Shell 内执行；否则在环境变量 `PATH` 中检查是否有同名可执行文件，若有，则创建进程执行该可执行文件；否则检查是否为可执行文件路径，若是，则执行该可执行文件。
  - 目前支持的内置命令为 `cd` 和 `echo`
- 对于重定向节点：先打开重定向文件，通过 `dup2` 更改进程标准输入输出，执行其左节点（命令节点），执行完成后恢复标准输入输出。
- 对于管道节点：构建管道，新建子进程执行左子树，进程输出为管道入端；父进程递归执行管道节点右子树。
  - 没有考虑管道节点左右端存在内置命令的情形。

### 效果展示

! [yaush](yaush.png)
